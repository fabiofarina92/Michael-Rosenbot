kind: pipeline
name: default
type: docker

steps:
  - name: test
    image: node
    commands:
      - npm install
      - npm test

  - name: deploy
    image: appleboy/drone-scp
    when:
      branch:
        include:
          - master
      event:
        exclude:
          - pull_request
    settings:
      host: 192.168.0.197
      user: arthas
      key:
        from_secret: ssh_key
      target: /home/arthas/staging/michael-rosenbot
      source: "*"

  - name: run
    image: appleboy/drone-ssh
    when:
      branch:
        include:
          - master
      event:
        exclude:
          - pull_request
    settings:
      host: 192.168.0.197
      user: arthas
      key:
        from_secret: ssh_key
      script:
      - cp ~/secrets.json ~/staging/michael-rosenbot
      - cd ~/staging/michael-rosenbot
      - mkdir ~/staging/michael-rosenbot/data
      - docker build -t michael-rosenbot .
      - docker stop michael-rosenbot
      - docker container rm michael-rosenbot
      - docker run -d --name michael-rosenbot -v mr-data:/usr/src/michael-rosenbot/data michael-rosenbot

